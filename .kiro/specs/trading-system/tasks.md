# Implementation Plan: Trading System

## Overview

本实现计划将商品交易系统的设计分解为可执行的编码任务。采用增量开发方式，从项目基础设施开始，逐步实现各个业务模块，确保每个步骤都能构建和测试。

## Tasks

- [x] 1. 项目初始化和基础设施
  - [x] 1.1 创建Spring Boot项目结构
    - 使用Spring Initializr创建Maven项目
    - 添加依赖：Spring Web, Mybatis Plus, Mysql, Lombok, Validation, junit
    - 配置application.yml（数据库、服务器端口、日志）
    - _Requirements: 9.1, 10.1, 10.8_
  - [x] 1.2 创建基础响应和异常类
    - 实现ApiResponse通用响应类
    - 实现BusinessException及其子类
    - 实现GlobalExceptionHandler
    - _Requirements: 8.4, 8.5_
  - [x] 1.3 创建枚举类型
    - 实现OrderStatus枚举
    - 实现TransactionType枚举
    - 实现SettlementStatus枚举
    - _Requirements: 6.1_

- [x] 2. 用户模块实现
  - [x] 2.1 创建User实体和Repository
    - 实现User实体类（id, username, password, balance, version）
    - 实现UserRepository接口
    - _Requirements: 1.1, 9.1_
  - [x] 2.2 实现UserService接口和实现类
    - 实现用户注册（创建零余额账户）
    - 实现用户登录验证
    - 实现余额查询
    - 实现充值功能（余额增加）
    - _Requirements: 1.1, 1.2, 1.4, 1.5_
  - [x] 2.3 编写Property Test: 账户初始化正确性
    - **Property 1: Account Initialization Correctness**
    - **Validates: Requirements 1.1**
  - [x] 2.4 编写Property Test: 充值余额正确性
    - **Property 2: Deposit Balance Correctness**
    - **Validates: Requirements 1.4**
  - [x] 2.5 编写Property Test: 无效充值拒绝
    - **Property 3: Invalid Deposit Rejection**
    - **Validates: Requirements 1.6**
  - [x] 2.6 实现UserController
    - POST /api/v1/users/register
    - POST /api/v1/users/login
    - GET /api/v1/users/{id}/balance
    - POST /api/v1/users/{id}/deposit
    - _Requirements: 8.1, 8.2, 8.3_
  - [x] 2.7 编写UserController集成测试
    - 测试注册、登录、充值API
    - _Requirements: 11.2_

- [x] 3. Checkpoint - 用户模块验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 4. 商家模块实现
  - [x] 4.1 创建Merchant实体和Repository
    - 实现Merchant实体类（id, businessName, username, password, balance, version）
    - 实现MerchantRepository接口
    - _Requirements: 2.1, 9.1_
  - [x] 4.2 创建Product实体和Repository
    - 实现Product实体类（id, name, description, category, merchantId）
    - 实现ProductRepository接口
    - _Requirements: 2.3, 3.1_
  - [x] 4.3 创建Inventory实体和Repository
    - 实现Inventory实体类（id, sku, productId, merchantId, quantity, price, version）
    - 实现InventoryRepository接口
    - _Requirements: 2.4, 9.4_
  - [x] 4.4 实现MerchantService接口和实现类
    - 实现商家注册
    - 实现商家登录
    - 实现余额查询
    - _Requirements: 2.1, 2.2, 2.9_
  - [x] 4.5 实现ProductService接口和实现类
    - 实现商品创建
    - 实现商品搜索（关键词、分类）
    - 实现商品详情查询
    - _Requirements: 2.3, 3.1, 3.2, 3.3, 3.4_
  - [x] 4.6 实现InventoryService接口和实现类
    - 实现库存添加
    - 实现价格更新
    - 实现库存查询
    - _Requirements: 2.4, 2.5, 2.6, 2.7_
  - [x] 4.7 编写Property Test: 库存添加正确性
    - **Property 4: Inventory Addition Correctness**
    - **Validates: Requirements 2.4**
  - [x] 4.8 编写Property Test: 无效库存拒绝
    - **Property 5: Invalid Inventory Rejection**
    - **Validates: Requirements 2.8**
  - [x] 4.9 编写Property Test: 搜索结果相关性
    - **Property 14: Search Result Relevance**
    - **Validates: Requirements 3.2**
  - [x] 4.10 实现MerchantController
    - POST /api/v1/merchants/register
    - POST /api/v1/merchants/login
    - GET /api/v1/merchants/{id}/balance
    - POST /api/v1/merchants/{id}/inventory
    - PUT /api/v1/merchants/{id}/inventory/{sku}/price
    - GET /api/v1/merchants/{id}/inventory
    - _Requirements: 8.1, 8.2_
  - [x] 4.11 实现ProductController
    - POST /api/v1/products
    - GET /api/v1/products
    - GET /api/v1/products/{id}
    - _Requirements: 8.1, 8.2_
  - [x] 4.12 编写商家和商品Controller集成测试
    - _Requirements: 11.2_

- [x] 5. Checkpoint - 商家模块验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 购物车模块实现
  - [x] 6.1 创建CartItem实体和Repository
    - 实现CartItem实体类（id, userId, sku, quantity）
    - 实现CartItemRepository接口
    - _Requirements: 4.1_
  - [x] 6.2 实现CartService接口和实现类
    - 实现添加商品到购物车
    - 实现更新购物车商品数量
    - 实现删除购物车商品
    - 实现查看购物车（含总价计算）
    - 实现清空购物车
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.7_
  - [x] 6.3 编写Property Test: 购物车总价计算正确性
    - **Property 6: Cart Total Calculation Correctness**
    - **Validates: Requirements 4.7**
  - [x] 6.4 实现CartController
    - POST /api/v1/cart/items
    - PUT /api/v1/cart/items/{sku}
    - DELETE /api/v1/cart/items/{sku}
    - GET /api/v1/cart
    - DELETE /api/v1/cart
    - _Requirements: 8.1, 8.2_
  - [x] 6.5 编写CartController集成测试
    - _Requirements: 11.2_

- [x] 7. Checkpoint - 购物车模块验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 8. 订单模块实现
  - [x] 8.1 创建Order和OrderItem实体
    - 实现Order实体类（id, orderNumber, userId, merchantId, totalAmount, status, items）
    - 实现OrderItem实体类（id, orderId, sku, productName, quantity, unitPrice, subtotal）
    - 实现OrderRepository和OrderItemRepository
    - _Requirements: 5.1, 5.8_
  - [x] 8.2 创建TransactionRecord实体和Repository
    - 实现TransactionRecord实体类
    - 实现TransactionRecordRepository
    - _Requirements: 1.7, 9.5_
  - [x] 8.3 实现TransactionService
    - 实现创建交易记录
    - 实现查询交易历史
    - _Requirements: 1.7, 1.8_
  - [x] 8.4 实现OrderService接口和实现类 - 订单创建
    - 实现从购物车创建订单
    - 实现直接购买创建订单
    - 实现订单号生成（时间戳前缀）
    - _Requirements: 5.1, 5.2, 5.3_
  - [x] 8.5 实现OrderService - 支付处理（核心事务）
    - 实现支付确认（原子操作：扣用户余额、加商家余额、减库存）
    - 实现余额不足校验
    - 实现库存不足校验
    - 使用@Transactional确保原子性
    - _Requirements: 5.4, 5.5, 5.6, 5.8, 5.9, 5.11, 9.2_
  - [x] 8.6 编写Property Test: 订单总价计算正确性
    - **Property 7: Order Total Calculation Correctness**
    - **Validates: Requirements 5.2**
  - [x] 8.7 编写Property Test: 购买事务原子性
    - **Property 8: Purchase Transaction Atomicity**
    - **Validates: Requirements 5.4, 5.5, 5.6, 5.11**
  - [x] 8.8 编写Property Test: 余额不足拒绝
    - **Property 9: Insufficient Balance Rejection**
    - **Validates: Requirements 5.8**
  - [x] 8.9 编写Property Test: 库存不足拒绝
    - **Property 10: Insufficient Stock Rejection**
    - **Validates: Requirements 5.9**
  - [x] 8.10 实现OrderService - 订单状态管理
    - 实现发货（PAID → SHIPPED）
    - 实现确认收货（SHIPPED → COMPLETED）
    - 实现取消订单（PENDING → CANCELLED）
    - 实现退款（PAID/SHIPPED → REFUNDED，退还余额）
    - _Requirements: 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 8.11 编写Property Test: 退款事务正确性
    - **Property 11: Refund Transaction Correctness**
    - **Validates: Requirements 6.7**
  - [x] 8.12 编写Property Test: 交易记录完整性
    - **Property 15: Transaction Record Completeness**
    - **Validates: Requirements 1.7**
  - [x] 8.13 实现OrderController
    - POST /api/v1/orders/from-cart
    - POST /api/v1/orders/direct
    - POST /api/v1/orders/{id}/pay
    - POST /api/v1/orders/{id}/ship
    - POST /api/v1/orders/{id}/complete
    - POST /api/v1/orders/{id}/cancel
    - POST /api/v1/orders/{id}/refund
    - GET /api/v1/orders/{id}
    - GET /api/v1/orders
    - _Requirements: 8.1, 8.2, 8.6_
  - [x] 8.14 编写OrderController集成测试
    - _Requirements: 11.2_

- [x] 9. Checkpoint - 订单模块验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 并发处理和乐观锁测试
  - [x] 10.1 验证乐观锁配置
    - 确认User、Merchant、Inventory实体的@Version字段
    - 配置OptimisticLockingFailureException处理
    - _Requirements: 9.4_
  - [x] 10.2 编写Property Test: 并发购买安全性
    - **Property 13: Concurrent Purchase Safety**
    - 使用多线程模拟并发购买
    - **Validates: Requirements 9.4**
  - [x] 10.3 编写并发购买集成测试
    - 测试多用户同时购买同一库存
    - _Requirements: 11.3_

- [x] 11. 结算模块实现
  - [x] 11.1 创建Settlement实体和Repository
    - 实现Settlement实体类
    - 实现SettlementRepository
    - _Requirements: 7.5, 7.6_
  - [x] 11.2 实现SettlementService接口和实现类
    - 实现每日结算计算（已完成订单总额）
    - 实现退款扣除计算
    - 实现余额变动对比
    - 实现结算状态判定（MATCHED/MISMATCHED）
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [x] 11.3 编写Property Test: 结算计算正确性
    - **Property 12: Settlement Calculation Correctness**
    - **Validates: Requirements 7.1**
  - [x] 11.4 实现SettlementScheduler定时任务
    - 使用@Scheduled配置每日执行
    - 支持通过配置文件设置执行时间
    - _Requirements: 7.6, 7.7, 10.7_
  - [x] 11.5 实现SettlementController
    - GET /api/v1/merchants/{id}/settlements
    - _Requirements: 7.8_
  - [x] 11.6 编写结算模块集成测试
    - _Requirements: 11.2_

- [x] 12. Checkpoint - 结算模块验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 13. 完整流程集成测试
  - [x] 13.1 编写完整购买流程集成测试
    - 用户注册 → 充值 → 浏览商品 → 加购物车 → 下单 → 支付 → 发货 → 确认收货
    - _Requirements: 11.2_
  - [x] 13.2 编写退款流程集成测试
    - 完成订单 → 申请退款 → 验证余额变动
    - _Requirements: 11.2_
  - [x] 13.3 编写结算流程集成测试
    - 创建多个订单 → 运行结算 → 验证结算结果
    - _Requirements: 11.2_

- [x] 14. Final Checkpoint - 全部测试验证
  - 运行所有测试确保通过
  - 验证测试覆盖率达到80%
  - 如有问题请询问用户

## Notes

- 每个任务都引用了具体的需求条款以确保可追溯性
- Checkpoint任务用于阶段性验证，确保增量开发的正确性
- Property测试验证核心业务逻辑的正确性属性
- 集成测试验证API端点和完整业务流程
- 所有测试任务均为必需，确保80%以上测试覆盖率
